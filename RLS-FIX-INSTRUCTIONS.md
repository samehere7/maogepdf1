# RLS 权限修复指导文档

## 概述

由于Supabase JavaScript客户端的限制，无法通过编程方式执行DDL（数据定义语言）语句。因此，需要手动在Supabase SQL编辑器中执行RLS权限修复脚本。

## 执行步骤

### 1. 访问Supabase项目控制台

打开以下链接访问项目控制台：
```
https://supabase.com/dashboard/project/pwlvfmywfzllopuiisxg
```

### 2. 进入SQL编辑器

在项目控制台左侧导航栏中，找到并点击 **SQL Editor**。

### 3. 执行SQL脚本

1. 在SQL编辑器中创建一个新查询
2. 将 `rls-fix-complete.sql` 文件的完整内容复制到查询编辑器中
3. 点击 **Run** 按钮执行脚本

### 4. 验证执行结果

脚本执行后，您应该看到以下输出：

1. **状态消息**: `'RLS policies and functions created successfully'`
2. **策略列表**: 显示所有创建的RLS策略
3. **函数信息**: 显示创建的`update_user_plus_status`函数

## 脚本功能说明

### 🔒 RLS策略修复

脚本将为以下表创建统一的RLS策略：

- **user_profiles**: 用户个人资料表
- **plus**: Plus会员状态表  
- **user_daily_quota**: 用户每日配额表

每个表都会有两个策略：
- **owner_policy**: 允许用户访问自己的数据 (`auth.uid() = id`)
- **service_role_policy**: 允许服务角色访问所有数据 (`auth.role() = 'service_role'`)

### 🔧 Plus状态更新函数

创建 `update_user_plus_status` 函数，用于：
- 更新用户的Plus会员状态
- 同时更新 `user_profiles` 和 `plus` 两个表
- 提供事务性操作和错误处理
- 返回JSON格式的操作结果

## 预期影响

执行此脚本后，将解决以下问题：

1. ✅ **权限问题**: 修复所有RLS权限相关错误
2. ✅ **数据同步**: 确保Plus状态在多个表之间的一致性
3. ✅ **API功能**: 恢复支付和Plus会员功能的正常工作
4. ✅ **安全性**: 保证数据安全访问控制

## 故障排除

### 如果执行失败

1. **检查权限**: 确保您具有项目的管理员权限
2. **逐段执行**: 如果整个脚本失败，可以分段执行：
   - 先执行RLS启用部分
   - 再执行策略删除部分
   - 然后执行策略创建部分
   - 最后执行函数创建部分

### 常见错误处理

- **策略已存在错误**: 脚本使用 `DROP POLICY IF EXISTS`，应该不会出现此错误
- **权限不足错误**: 确保使用项目所有者账户执行
- **函数创建失败**: 检查是否有语法错误或权限问题

## 验证成功

执行完成后，可以通过以下方式验证：

1. **查看策略**: 在Supabase控制台的表编辑器中检查RLS策略
2. **测试功能**: 尝试Plus会员相关功能是否正常工作
3. **检查日志**: 查看应用程序日志确认不再有权限错误

## 联系信息

如果在执行过程中遇到问题，请提供：
- 具体的错误消息
- 执行到哪一步时出现问题
- Supabase项目控制台的截图（如果可能的话）

---

**注意**: 此脚本是一次性修复方案，执行成功后无需重复运行。